name: Update IPT and ISS Files

on:
  workflow_dispatch:
    inputs:
      version_input:
        description: 'Version|版本号'
        required: true
        default: '1.0.0'
      before_install_content:
        description: '更新内容 (留空则使用默认)'
        required: false
      after_install_content:
        description: '安装后内容 (留空则使用默认)'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update IPT Files
        run: |
          # 1. 基础变量
          VER="${{ github.event.inputs.version_input }}"
          IPT_DIR="Setup/ipt"
          mkdir -p "$IPT_DIR"
          
          # 定义目标文件名
          BEFORE_NAME="IPF-${VER}.txt"
          AFTER_NAME="IAF-${VER}.txt"
          
          # 2. 处理 安装前文件 (IPF)
          if [ -n "${{ github.event.inputs.before_install_content }}" ]; then
            echo "${{ github.event.inputs.before_install_content }}" > "${IPT_DIR}/${BEFORE_NAME}"
            echo "✅ 已创建内容文件: ${BEFORE_NAME}"
          else
            cp "src/ipt/安装前文件.txt" "${IPT_DIR}/${BEFORE_NAME}" || echo "⚠️ 找不到默认源文件"
            echo "ℹ️ 已从默认模板创建: ${BEFORE_NAME}"
          fi

          # 3. 处理 安装后文件 (IAF)
          if [ -n "${{ github.event.inputs.after_install_content }}" ]; then
            echo "${{ github.event.inputs.after_install_content }}" > "${IPT_DIR}/${AFTER_NAME}"
            echo "✅ 已创建内容文件: ${AFTER_NAME}"
          else
            cp "src/ipt/安装后文件.txt" "${IPT_DIR}/${AFTER_NAME}" || echo "⚠️ 找不到默认源文件"
            echo "ℹ️ 已从默认模板创建: ${AFTER_NAME}"
          fi

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 提交：生成的 IPF/IAF 文件
          git add "Setup/ipt/" "Backup/iss/"
          git commit -m "Update ISS: version ${{ github.event.inputs.version_input }}"
          git push
