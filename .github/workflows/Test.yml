name: Update PVZ_Weihua Assets

on:
  workflow_dispatch:
    inputs:
      version_input:
        description: 'è¯·è¾“å…¥ç‰ˆæœ¬å· (ä¾‹å¦‚ 1.2.0)'
        required: true
        default: '1.0.0'
      add_tools:
        description: 'æ˜¯å¦æ·»åŠ  Tools æ–‡ä»¶å¤¹åˆ° PVZ_Weihuaï¼Ÿ'
        type: boolean
        default: false
      before_install_content:
        description: 'ä¿®æ”¹å®‰è£…å‰æ–‡æœ¬ (ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤)'
        required: false
      after_install_content:
        description: 'ä¿®æ”¹å®‰è£…åæ–‡æœ¬ (ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤)'
        required: false

jobs:
  sync-assets:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize Environment
        run: |
          echo "VER=${{ github.event.inputs.version_input }}" >> $GITHUB_ENV
          echo "TIME_STAMP=$(date +'%Y%m%d_%H%M')" >> $GITHUB_ENV
          echo "SHOULD_ADD_TOOLS=${{ github.event.inputs.add_tools }}" >> $GITHUB_ENV

      - name: Process Files and Directories
        run: |
          # --- 1. ç¯å¢ƒæ¸…ç† ---
          echo "ğŸ§¹ Cleaning up old directories..."
          rm -rf "PVZ_Weihua"
          rm -rf "Setup/ipt"
          sleep 0.5
          mkdir -p "PVZ_Weihua"
          mkdir -p "Setup/ipt"

          # --- 2. å¤åˆ¶ Tools æ–‡ä»¶å¤¹ ---
          if [ "$SHOULD_ADD_TOOLS" = "true" ]; then
            echo "ğŸš€ User selected [Yes], copying Tools..."
            sleep 0.5
            if [ -d "src/Tools" ]; then
              sleep 0.5
              cp -af "src/Tools" "PVZ_Weihua/"
              echo "âœ… src/Tools folder copied successfully."
            elif [ -d "src/tools" ]; then
              echo "âš ï¸ src/Tools (Upper case) not found, copying src/tools (Lower case)..."
              cp -af "src/tools" "PVZ_Weihua/"
            else
              echo "âŒ Error: Source Tools folder not found in src/"
              exit 1
            fi
          else
            sleep 0.5
            echo "â„¹ï¸ User selected [No], skipping Tools folder."
            mkdir -p ".\PVZ_Weihua"
          fi

          # --- 3. å¤„ç† IPT æ–‡æœ¬ä¸å¤‡ä»½ ---
          # å¤„ç†å®‰è£…å‰æ–‡æœ¬ (LBF)
          B_VAL="${{ github.event.inputs.before_install_content }}"
          if [ -z "$B_VAL" ]; then
            cp -f "src/IPT/IBF.txt" "Setup/ipt/IPF-${VER}.txt" || touch "Setup/ipt/IPF-${VER}.txt"
          else
            echo "$B_VAL" > "Setup/ipt/IPF-${VER}.txt"
          fi
          cp -f "Setup/ipt/IPF-${VER}.txt" "Backup/IPT/LBF_${VER}_${TIME_STAMP}.txt"

          # å¤„ç†å®‰è£…åæ–‡æœ¬ (LAF)
          A_VAL="${{ github.event.inputs.after_install_content }}"
          if [ -z "$A_VAL" ]; then
            cp -f "src/IPT/IAF.txt" "Setup/ipt/IAF-${VER}.txt" || touch "Setup/ipt/IAF-${VER}.txt"
          else
            echo "$A_VAL" > "Setup/ipt/IAF-${VER}.txt"
          fi
          cp -f "Setup/ipt/IAF-${VER}.txt" "Backup/IPT/LAF_${VER}_${TIME_STAMP}.txt"

          # --- 4. ä¿®æ”¹ ISS æ–‡ä»¶ (PVZ_Weihua_Setup.iss) ---
          ISS_FILE="Setup/PVZ_Weihua.iss"
          if [ -f "$ISS_FILE" ]; then
            echo "ğŸ“ Modifying $ISS_FILE ..."
            # æ›´æ–°ç‰ˆæœ¬å·å®šä¹‰
            sed -i "s/#define MyAppVerNum \".*\"/#define MyAppVerNum \"$VER\"/" "$ISS_FILE"
            sed -i "s/#define MyAppVerFull \".*\"/#define MyAppVerFull \"$VER\"/" "$ISS_FILE"
            
            # æ›´æ–°å®‰è£…ç¨‹åºå›¾æ ‡è·¯å¾„ (æŒ‡å‘ Setup\ICO)
            sed -i "s|SetupIconFile=.*|SetupIconFile=Setup\\\\ICO\\\\weihua ${VER}.ico|" "$ISS_FILE"
            
            # åˆ†å‘å‰¯æœ¬
            cp -f "$ISS_FILE" "Backup/iss/PVZ_Weihua_${VER}_${TIME_STAMP}.iss"
            cp -f "$ISS_FILE" "ConfigurationTemplate/iss/PVZ_Weihua.iss"
            echo "âœ… ISS modification and backup done."
          else
            echo "âŒ Error: $ISS_FILE not found in Setup/ directory."
            exit 1
          fi

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰ç›®æ ‡ç›®å½•ï¼Œç»•è¿‡å¯èƒ½çš„ .gitignore é™åˆ¶
          git add -f Setup/PVZ_Weihua.iss
          git add -f Setup/ipt/
          git add -f Backup/IPT/
          git add -f Backup/iss/
          git add -f ConfigurationTemplate/iss/
          git add -f PVZ_Weihua/

          if git diff --staged --quiet; then
            echo "No changes detected, skipping commit."
          else
            git commit -m "Auto-update v${VER} (Clean Sync & Tools Included)"
            git push origin HEAD
            echo "ğŸš€ Repository updated successfully!"
          fi
