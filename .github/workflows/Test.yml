name: Update ISS, IPT and Tools

on:
  workflow_dispatch:
    inputs:
      version_input:
        description: 'è¯·è¾“å…¥ç‰ˆæœ¬å· (å¦‚ 1.2.0)'
        required: true
        default: '1.0.0'
      add_tools:
        description: 'æ·»åŠ  tools æ–‡ä»¶å¤¹åˆ° PVZ_Weihua'
        type: boolean
        default: false
      before_install_content:
        description: 'æ›´æ–°å†…å®¹'
        required: false
      after_install_content:
        description: 'å®‰è£…åå†…å®¹'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize Environment Variables
        run: |
          # é”å®šæ ¸å¿ƒå˜é‡ï¼Œé˜²æ­¢è·¨æ­¥éª¤å¤±æ•ˆ
          echo "VER=${{ github.event.inputs.version_input }}" >> $GITHUB_ENV
          echo "TIME_STAMP=$(date +'%Y%m%d_%H%M')" >> $GITHUB_ENV
          echo "ADD_TOOLS=${{ github.event.inputs.add_tools }}" >> $GITHUB_ENV

      - name: Process Tools and IPT Files
        run: |
          # --- 2. å¤„ç† Tools æ–‡ä»¶å¤¹å¤åˆ¶ ---
          if [ "$ADD_TOOLS" = "true" ]; then
            echo "ğŸš€ æ­£åœ¨æ‰§è¡Œå¤åˆ¶æ“ä½œ..."
            mkdir -p "PVZ_Weihua"
            if [ -d "src/Tools" ]; then
              cp -rv src/Tools PVZ_Weihua/
              echo "âœ… tools æ–‡ä»¶å¤¹å†…å®¹å·²æˆåŠŸå¤åˆ¶åˆ° PVZ_Weihua"
            else
              echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°æºç›®å½• src/Tools"
              exit 1
            fi
          else
            echo "â„¹ï¸ ç”¨æˆ·é€‰æ‹© [å¦] æˆ–æœªå‹¾é€‰ï¼Œä¸æ‰§è¡Œå¤åˆ¶ã€‚"
          fi
          # 2. å¤„ç† IPT åŠå…¶å¤‡ä»½ (LBF & LAF)
          mkdir -p "Setup/ipt" "Backup/IPT"
          
          # å¤„ç†å®‰è£…å‰æ–‡æœ¬
          if [ -n "${{ github.event.inputs.before_install_content }}" ]; then
            echo "${{ github.event.inputs.before_install_content }}" > "Setup/ipt/IPF-${VER}.txt"
            cp "Setup/ipt/IPF-${VER}.txt" "Backup/IPT/LBF_${VER}_${TIME_STAMP}.txt"
          else
            cp "src/IPT/IBF.txt" "Setup/ipt/IPF-${VER}.txt"
            cp "src/IPT/IBF.txt" "Backup/IPT/LBF_${VER}_${TIME_STAMP}.txt"
          fi

          # å¤„ç†å®‰è£…åæ–‡æœ¬
          if [ -n "${{ github.event.inputs.after_install_content }}" ]; then
            echo "${{ github.event.inputs.after_install_content }}" > "Setup/ipt/IAF-${VER}.txt"
            cp "Setup/ipt/IAF-${VER}.txt" "Backup/IPT/LAF_${VER}_${TIME_STAMP}.txt"
          else
            cp "src/IPT/IAF.txt" "Setup/ipt/IAF-${VER}.txt"
            cp "src/IPT/IAF.txt" "Backup/IPT/LAF_${VER}_${TIME_STAMP}.txt"
          fi

      - name: Modify Original ISS File
        run: |
          ISS_FILE="Setup/PVZ_Weihua.iss"
          
          # ä¿®æ”¹åŸæ–‡ä»¶
          sed -i "s/#define MyAppVerNum \".*\"/#define MyAppVerNum \"$VER\"/" "$ISS_FILE"
          sed -i "s/#define MyAppVerFull \".*\"/#define MyAppVerFull \"$VER\"/" "$ISS_FILE"
          sed -i "s|SetupIconFile=.*|SetupIconFile=Setup\\\\ICO\\\\weihua ${VER}.ico|" "$ISS_FILE"
          
          # åŒæ­¥åˆ†å‘å¤‡ä»½å’Œæ¨¡æ¿
          mkdir -p "Backup/iss" "ConfigurationTemplate/iss"
          cp "$ISS_FILE" "Backup/iss/PVZ_Weihua_${VER}_${TIME_STAMP}.iss"
          cp "$ISS_FILE" "ConfigurationTemplate/iss/PVZ_Weihua.iss"

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æäº¤æ‰€æœ‰å˜åŠ¨
          git add .
          
          # åªæœ‰åœ¨æœ‰å˜åŠ¨æ—¶æ‰æäº¤ï¼Œé˜²æ­¢ Action æŠ¥é”™
          git diff --staged --quiet || (git commit -m "Update v$VER (Manual Trigger)" && git push)
