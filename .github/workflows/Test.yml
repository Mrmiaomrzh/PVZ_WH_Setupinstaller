name: Update ISS, IPT and Tools (Fixed Copy & Push)

on:
  workflow_dispatch:
    inputs:
      version_input:
        description: 'è«‹è¼¸å…¥ç‰ˆæœ¬è™Ÿ (å¦‚ 1.2.0)'
        required: true
        default: '1.0.0'
      add_tools:
        description: 'æ˜¯å¦æ·»åŠ  tools æ–‡ä»¶å¤¹åˆ° PVZ_Weihuaï¼Ÿ'
        type: boolean
        default: false
      before_install_content:
        description: 'ä¿®æ”¹ã€å®‰è£å‰æ–‡æœ¬ã€‘å…§å®¹'
        required: false
      after_install_content:
        description: 'ä¿®æ”¹ã€å®‰è£å¾Œæ–‡æœ¬ã€‘å…§å®¹'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize Env
        run: |
          echo "VER=${{ github.event.inputs.version_input }}" >> $GITHUB_ENV
          echo "TIME_STAMP=$(date +'%Y%m%d_%H%M')" >> $GITHUB_ENV
          echo "HAS_TOOLS=${{ github.event.inputs.add_tools }}" >> $GITHUB_ENV

      - name: Execute Copy and Modify Logic
        run: |
          # 1. è®Šé‡æº–å‚™
          VER="${{ github.event.inputs.version_input }}"
          
          # 2. è™•ç† PVZ_Weihua è³‡æ–™å¤¾ (åŠ å…¥åµæ¸¬èˆ‡æ¸…ç†é‚è¼¯)
          if [ "${{ github.event.inputs.add_tools }}" = "true" ]; then
            echo "ğŸ” æ­£åœ¨æª¢æŸ¥ PVZ_Weihua ç›®éŒ„..."
            if [ -d "PVZ_Weihua" ]; then
              echo "ğŸ—‘ï¸ åµæ¸¬åˆ°èˆŠè³‡æ–™å¤¾ï¼Œæ­£åœ¨æ¸…ç†å¾Œé‡æ–°è¤‡è£½..."
              rm -rf "PVZ_Weihua"
            fi
            
            mkdir -p "PVZ_Weihua"
            if [ -d "src/Tools" ]; then
              cp -af src/Tools PVZ_Weihua/
              echo "âœ… Tools å·²æˆåŠŸä¹¾æ·¨è¤‡è£½åˆ° PVZ_Weihua"
            else
              echo "âš ï¸ æ‰¾ä¸åˆ°ä¾†æº src/Toolsï¼Œè·³éè¤‡è£½"
            fi
          fi

          # 3. è™•ç† IPT æ–‡æœ¬èˆ‡å‚™ä»½
          # å®‰è£å‰
          if [ -n "${{ github.event.inputs.before_install_content }}" ]; then
            echo "${{ github.event.inputs.before_install_content }}" > "Setup/ipt/IPF-${VER}.txt"
          else
            cp -f "src/IPT/IBF.txt" "Setup/ipt/IPF-${VER}.txt" || touch "Setup/ipt/IPF-${VER}.txt"
          fi
          cp -f "Setup/ipt/IPF-${VER}.txt" "Backup/IPT/LBF_${VER}_${TIME_STAMP}.txt"

          # å®‰è£å¾Œ
          if [ -n "${{ github.event.inputs.after_install_content }}" ]; then
            echo "${{ github.event.inputs.after_install_content }}" > "Setup/ipt/IAF-${VER}.txt"
          else
            cp -f "src/IPT/IAF.txt" "Setup/ipt/IAF-${VER}.txt" || touch "Setup/ipt/IAF-${VER}.txt"
          fi
          cp -f "Setup/ipt/IAF-${VER}.txt" "Backup/IPT/LAF_${VER}_${TIME_STAMP}.txt"

          # 4. ä¿®æ”¹ ISS åŸæ–‡ä»¶
          ISS_FILE="Setup/PVZ_Weihua.iss"
          if [ -f "$ISS_FILE" ]; then
            # æ ¹æ“šä½ ä¸Šå‚³çš„å…§å®¹æº–ç¢ºåŒ¹é…è¡Œ 
            sed -i "s/#define MyAppVerNum \".*\"/#define MyAppVerNum \"$VER\"/" "$ISS_FILE"
            sed -i "s/#define MyAppVerFull \".*\"/#define MyAppVerFull \"$VER\"/" "$ISS_FILE"
            # ä¿®æ”¹åœ–æ¨™è·¯å¾‘
            sed -i "s|SetupIconFile=.*|SetupIconFile=Setup\\\\ICO\\\\weihua ${VER}.ico|" "$ISS_FILE"
            
            # åŒæ­¥åˆ°å‚™ä»½ä½å…ƒç½®
            cp -f "$ISS_FILE" "Backup/iss/PVZ_Weihua_${VER}_${TIME_STAMP}.iss"
            cp -f "$ISS_FILE" "ConfigurationTemplate/iss/PVZ_Weihua.iss"
            echo "âœ… ISS file updated and backed up"
          else
            echo "âŒ Error: $ISS_FILE not found"
            exit 1
          fi

      - name: Force Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # é¡¯å¼æ·»åŠ æ‰€æœ‰å—å½±éŸ¿çš„æ–‡ä»¶å¤¾ï¼Œé¿å…è¢« .gitignore å¿½ç•¥
          git add -f Setup/PVZ_Weihua.iss
          git add -f Setup/ipt/
          git add -f Backup/IPT/
          git add -f Backup/iss/
          git add -f ConfigurationTemplate/iss/
          git add -f PVZ_Weihua/

          # æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è®Šæ›´
          if git diff --staged --quiet; then
            echo "æ²’æœ‰æª¢æ¸¬åˆ°ä»»ä½•æ–‡ä»¶è®Šæ›´ï¼Œè·³éæäº¤ã€‚"
          else
            git commit -m "Update v${VER} - Auto Sync Assets"
            git push origin HEAD
            echo "ğŸš€ æ–‡ä»¶å·²æˆåŠŸæ¨é€è‡³å€‰åº«"
          fi
