name: Update IPT Text and ISS Files

on:
  workflow_dispatch:
    inputs:
      version_input:
        description: 'Version|版本号'
        required: true
        default: '1.0.0'
      before_install_content:
        description: '更新内容 (留空则沿用 src/IPT 中的默认文本)'
        required: false
      after_install_content:
        description: '安装后内容 (留空则沿用 src/IPT 中的默认文本)'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process IPT Text Files
        run: |
          # 1. 确保版本号存在，如果为空则强制停止
          VER="${{ github.event.inputs.version_input }}"
          if [ -z "$VER" ]; then
            echo "❌ 错误: 版本号不能为空"
            exit 1
          fi

          IPT_DIR="Setup/ipt"
          mkdir -p "$IPT_DIR"
          
          # 2. 定义目标完整路径
          BEFORE_FILE="${IPT_DIR}/IPF-${VER}.txt"
          AFTER_FILE="${IPT_DIR}/IAF-${VER}.txt"
          
          echo "目标路径: $BEFORE_FILE"

          # 3. 处理安装前内容 (IBF.txt)
          # 注意：使用 python 或 cat 避免 echo 的双引号被 shell 错误解析
          if [ -n "${{ github.event.inputs.before_install_content }}" ]; then
            cat <<EOF > "$BEFORE_FILE"
          ${{ github.event.inputs.before_install_content }}
          EOF
            echo "✅ 已根据输入修改并生成: $BEFORE_FILE"
          else
            cp "src/IPT/IBF.txt" "$BEFORE_FILE" || { echo "❌ 找不到 src/IPT/IBF.txt"; exit 1; }
            echo "ℹ️ 已使用 src/IPT 默认模板"
          fi

          # 4. 处理安装后内容 (IAF.txt)
          if [ -n "${{ github.event.inputs.after_install_content }}" ]; then
            cat <<EOF > "$AFTER_FILE"
          ${{ github.event.inputs.after_install_content }}
          EOF
            echo "✅ 已根据输入修改并生成: $AFTER_FILE"
          else
            cp "src/IPT/IAF.txt" "$AFTER_FILE" || { echo "❌ 找不到 src/IPT/IAF.txt"; exit 1; }
            echo "ℹ️ 已使用 src/IPT 默认模板"
          fi

      - name: Process ISS File
        run: |
          VER="${{ github.event.inputs.version_input }}"
          TIME_STAMP=$(date +'%Y%m%d_%H%M')
          
          ORIGINAL_FILE="Setup/PVZ_Weihua.iss"
          BACKUP_DIR="Backup/iss"
          TEMPLATE_DIR="ConfigurationTemplate/iss"
          
          mkdir -p "$BACKUP_DIR" "$TEMPLATE_DIR"

          # 修改并分发
          sed -e "s/\(#define MyAppVerNum \)\".*\"/\1\"$VER\"/" \
              -e "s/\(#define MyAppVerFull \)\".*\"/\1\"$VER\"/" \
              "$ORIGINAL_FILE" > "${BACKUP_DIR}/PVZ_Weihua_${VER}_${TIME_STAMP}.iss"

          cp "${BACKUP_DIR}/PVZ_Weihua_${VER}_${TIME_STAMP}.iss" "${TEMPLATE_DIR}/PVZ_Weihua.iss"

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add "Setup/ipt/" "Backup/iss/" "ConfigurationTemplate/iss/"
          
          # 检查是否有改动，防止 commit 报错
          if git diff --staged --quiet; then
            echo "没有发现文件变动，跳过提交"
          else
            git commit -m "Update ISS: version ${{ github.event.inputs.version_input }}"
            git push
          fi
