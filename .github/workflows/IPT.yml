name: Update IPT Text and ISS Files

on:
  workflow_dispatch:
    inputs:
      version_input:
        description: 'Version|ç‰ˆæœ¬å·'
        required: true
        default: '1.0.0'
      add_tools:
        description: 'æ˜¯å¦æ·»åŠ  tools æ–‡ä»¶å¤¹ï¼Ÿ'
        type: boolean
        default: false
      before_install_content:
        description: 'æ›´æ–°å†…å®¹ (ç•™ç©ºåˆ™æ²¿ç”¨ src/IPT ä¸­çš„é»˜è®¤æ–‡æœ¬)'
        required: false
      after_install_content:
        description: 'å®‰è£…åå†…å®¹ (ç•™ç©ºåˆ™æ²¿ç”¨ src/IPT ä¸­çš„é»˜è®¤æ–‡æœ¬)'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process IPT Text Files
        run: |
          # æ£€æŸ¥ç‰ˆæœ¬å·
          VER="${{ github.event.inputs.version_input }}"
          if [ -z "$VER" ]; then
            echo "âŒ é”™è¯¯: ç‰ˆæœ¬å·ä¸èƒ½ä¸ºç©º"
            exit 1
          fi

          IPT_DIR="Setup/ipt"
          mkdir -p "$IPT_DIR"
          
          # å®šä¹‰ç›®æ ‡å®Œæ•´è·¯å¾„
          BEFORE_FILE="${IPT_DIR}/IPF-${VER}.txt"
          AFTER_FILE="${IPT_DIR}/IAF-${VER}.txt"
          
          # å¤„ç†å®‰è£…å‰å†…å®¹ (IBF.txt)
          if [ -n "${{ github.event.inputs.before_install_content }}" ]; then
            cat <<EOF > "$BEFORE_FILE"
          ${{ github.event.inputs.before_install_content }}
          EOF
          else
            cp "src/IPT/IBF.txt" "$BEFORE_FILE" || { echo "âŒ æ‰¾ä¸åˆ° src/IPT/IBF.txt"; exit 1; }
          fi

          # å¤„ç†å®‰è£…åå†…å®¹ (IAF.txt)
          if [ -n "${{ github.event.inputs.after_install_content }}" ]; then
            cat <<EOF > "$AFTER_FILE"
          ${{ github.event.inputs.after_install_content }}
          EOF
          else
            cp "src/IPT/IAF.txt" "$AFTER_FILE" || { echo "âŒ æ‰¾ä¸åˆ° src/IPT/IAF.txt"; exit 1; }
          fi

          # å¤„ç† Tools æ–‡ä»¶å¤¹
          - name: Process Logic
        run: |
          # --- 1. å˜é‡åˆå§‹åŒ– ---
          VER="${{ github.event.inputs.version_input }}"
          # å¼ºåˆ¶å°†è¾“å…¥è½¬æ¢ä¸ºå°å†™ï¼Œç¡®ä¿åˆ¤æ–­ç¨³å¥
          ADD_TOOLS_RAW="${{ github.event.inputs.add_tools }}"
          ADD_TOOLS=$(echo "$ADD_TOOLS_RAW" | tr '[:upper:]' '[:lower:]')
          
          echo "Debug: æ¥æ”¶åˆ°çš„ add_tools åŸå€¼ = '$ADD_TOOLS_RAW'"
          echo "Debug: è½¬æ¢åçš„åˆ¤æ–­å€¼ = '$ADD_TOOLS'"

          # --- 2. å¤„ç† Tools æ–‡ä»¶å¤¹å¤åˆ¶ ---
          if [ "$ADD_TOOLS" = "true" ]; then
            echo "ğŸš€ æ­£åœ¨æ‰§è¡Œå¤åˆ¶æ“ä½œ..."
            mkdir -p "PVZ_Weihua"
            if [ -d "src/tools" ]; then
              cp -rv src/tools/. PVZ_Weihua/
              echo "âœ… tools æ–‡ä»¶å¤¹å†…å®¹å·²æˆåŠŸå¤åˆ¶åˆ° PVZ_Weihua"
            else
              echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°æºç›®å½• src/tools"
              exit 1
            fi
          else
            echo "â„¹ï¸ ç”¨æˆ·é€‰æ‹© [å¦] æˆ–æœªå‹¾é€‰ï¼Œä¸æ‰§è¡Œå¤åˆ¶ã€‚"
          fi

      - name: Process ISS File
        run: |
          VER="${{ github.event.inputs.version_input }}"
          TIME_STAMP=$(date +'%Y%m%d_%H%M')
          
          ORIGINAL_FILE="Setup/PVZ_Weihua.iss"
          BACKUP_DIR="Backup/iss"
          TEMPLATE_DIR="ConfigurationTemplate/iss"
          
          mkdir -p "$BACKUP_DIR" "$TEMPLATE_DIR"

          # ä¿®æ”¹å¹¶åˆ†å‘
          sed -e "s/\(#define MyAppVerNum \)\".*\"/\1\"$VER\"/" \
              -e "s/\(#define MyAppVerFull \)\".*\"/\1\"$VER\"/" \
              "$ORIGINAL_FILE" > "${BACKUP_DIR}/PVZ_Weihua_${VER}_${TIME_STAMP}.iss"

          cp "${BACKUP_DIR}/PVZ_Weihua_${VER}_${TIME_STAMP}.iss" "${TEMPLATE_DIR}/PVZ_Weihua.iss"

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add "Setup/ipt/" "Backup/iss/" "ConfigurationTemplate/iss/" "PVZ_Weihua/"
          
          git commit -m "Update ISS: version ${{ github.event.inputs.version_input }}"
          git push

